# BslLogExporter

Экспорт логов 1С в любое место, с помощью скриптов C# / 1C

### Основные фичи

- Поддержка написание скриптов - экспортеров на 2 языках:
    - C# - Dotnet script (требуется установленный dotnet sdk) https://github.com/dotnet-script/dotnet-script#prerequisites
    - 1C - OneScript https://github.com/EvilBeaver/OneScript
- Hot reload: изменения в конфигурации или источнике логов (добавлена ИБ в кластер и тд) приведет к обновлению процесса выгрузки логов в приложении без его перезапуска
- Экспорт из конкретной папки логов и / или папки кластера с возможностью фильтрации информационных баз
- Возможность выгрузки в режиме реально времени, либо "задним числом" с сохранением прогресса и возобнавлении с последней записи
- Возможность выгрузки записей логов сразу в несколько мест
- Возможен запуск как консольного приложения, windows сервиса или в контейнере

Настройка процесса выгрузки производится через файл **AppConfiguration.json**

Пример конфигурационного файла

```json

{
    // Настройки обработки
    "Processing": {
      // Опционально - Размер буфера (По умолчанию 5000)
      "Buffer": 10000,
      // Опционально - Таймаут в секундах особождения буфера, если он не был заполнен (по умолчанию 5 сек)
      "TimeoutSeconds": 10
    },
    // Настройки истории выгрузки
    "History": {
      // Опционально - Флаг включения / выключения ведения истории выгрузки (по умолчанию выкл)
      "Use": true,
      // Опционально, если история не ведется: Путь к json файлу хранения истории
      "HistoryFile": "C:\\MyHistory.json"
    },
    // Настройки движка Dotnet-script
    "CsScript": {
      "TargetFramework": "net7.0", // целевая версия .net на которой будут компилироваться скрипты
      "CacheDirectory": "{WorkingDir}/csx_cache" // путь к папке с кешем билдов
    },
    // Настройки движка OneScript
    "OneScript": {
      "LibDirectory": "C:\\Program Files (x86)\\OneScript\\lib" // Путь к библиотекам OneScript
    },
    // Данные источников
    "Sources": [
        {
            // Обязательно - Выгрузка из папки
            "Type": "Folder", 
            "Args": {
                // Обязательно - Имя источника логов
                "Name": "MyIb",
                // Опицонально - Флаг выгрузки в режиме реального времени (по умолчанию выкл)
                // Live mode работает только при отсутсвии записей в истории выгрузки
                // Грубо говоря при первой выгрузке логов
                // Как только запись появилась по данному источнику,
                // то выгрузка продолжится с момента последнего сохранения
                "LiveMode": true
            }
        },
        {
            // Обязательно - Выгрузка из кластера
            "Type": "Cluster", 
            "Args": {
                // Обязательно - Паттерн формирования имени источника логов
                "NamePattern": "MyCluster:{IbName}",
                // Обязательно - Путь к папке кластера
                "FolderPath": "",
                // Опицонально - Флаг выгрузки в режиме реального времени (по умолчанию выкл)
                // Live mode работает только при отсутсвии записей в истории выгрузки
                // Грубо говоря при первой выгрузке логов
                // Как только запись появилась по данному источнику,
                // то выгрузка продолжится с момента последнего сохранения
                "LiveMode": true
            }
        }
    ],
    // Данные экспортеров
    "Exporters": [
        {
            // Обязательно - Экспортер на C#
            "Type": "CsScript",
            //Обязательно - Фильтр (Regex) источников, которые будут выгружены через данный экспортер
            "SourceFilter": "MyCluster:ZUP", 
            "Args": {
                // Обязательно - Путь к скрипту
                "PathToScript": "./MyExporter.csx",
                "ScriptArgs": [
                    // Опционально - Аргументы скрипта (массив строк)
                ]
            }
        },
        {
          // Обязательно - Экспортер на OneScript
          "Type": "OneScript",
          //Обязательно - Фильтр (Regex) источников, которые будут выгружены через данный экспортер
          "SourceFilter": "MyCluster:ZUP",
          // Обязательно - Путь к скрипту
          "Args": {
            // Обязательно - Путь к скрипту
            "PathToScript": "./MyExporter.os",
            "ScriptArgs": [
              // Опционально - Аргументы скрипта (массив строк)
            ]
          }
        }
    ]
}

```

Так же парамеры можно задать через переменные окружения с префиксом `BslLogExporter`

Например:

BslLogExporter:Processing:Buffer=5000

### Описание вариантов запуска:

Все варианты запуска поддерживают возможность переопределения рабочей директории

Параметр `WorkingDir`

В заданной папке будет произведен поиск AppConfiguration.json

Так же от нее будут строиться все относительные пути

Указать папку можно двумя способами:

1) Установить переменную окружения BslLogExporter:WorkingDir=C:\MyFolder
2) Установить аргумент командной строки /WorkingDir=C:\MyFolder

##### - Запуск из командной строки -

Пример команды:

`C:\exporter\BslLogExporter.exe /WorkingDir=D:\exporter_config_folder`

##### - Запуск как службы Windows -

Пример команды:

`sc create BslLogExporter binpath= "C:\exporter\BslLogExporter.exe /WorkingDir=%workingDir%"`

#### - Запуск в docker контейнер -

Пример файла docker-compose в корне проекта

PS: Не тестировалось :(

### Логирование ###

Логирование осуществляется через Serilog

В данный момент доступен вывод в:

- Файл: https://github.com/serilog/serilog-sinks-file
- Консоль: https://github.com/serilog/serilog-sinks-console

### Возможные проблемы ###

- Не компилируются csx скрипты с ошибкой NU1100

Решение: В рабочую директорию необходимо поместить файл NuGet.Config, пример файла в папке examples


